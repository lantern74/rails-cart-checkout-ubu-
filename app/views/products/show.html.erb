<%#= notice %>
<%#=@product.title @product.price @product.description %>
<div class="d-flex flex-column min-vh-100 justify-content-center align-items-center">

  <section class="col-sm-12 col-md-10 col-lg-7">
    <div class="row align-items-center">
      <div class="col-xs-12 col-sm-6 px-4" style="text-align:center">
        <div class="text-left px-4">
        <img style="width:15px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQEAAADECAMAAACoYGR8AAAAdVBMVEX///8AAADKysqJiYl3d3eAgICOjo6CgoKGhoZxcXF6enqWlpaZmZlfX199fX1iYmJHR0fd3d00NDRycnJsbGxVVVVPT0/R0dEPDw/x8fGgoKBERETj4+Orq6s7OzsaGhonJye6urq/v7/t7e2vr6+lpaUuLi4V7UVvAAADZ0lEQVR4nO3dC1YaURCE4WoRRVFARNEIImjc/xITojGRx9D35PRU7Fv/ApLyO4A4MDNAZLP58HFhT6PuKvS/+W9bLexPwxl7Tutdje1z5+xFLbe0rV7v2aParL8N8LOKngknOwHMqnkU7AOwEXtZS+0FMJuzt7VSA4AZe1wbNQLYN/a8+JoBbMzeF16nGcDsmb0wuIMAtmRPjO0wgL2wN4bmALA+e2RkHgA7Za8MrOcBsO/smXH5ABK/EjoB7Ig9NCovQNq3xW6ACXtpUKdeAJuyp8bkB7hkT43JD5D0OFkBQM63xF0/QI+9NaQCgDP21pCqBxj4Aa7ZW0MSgADcHbO3hnQuAAHUDXDsB8j51QkBCMDdgL01pOoBrgXgrsveGlL1AGcCcJfzI1IB1A4w8QPkPCosAAEIwFuHvTUkAQigcoChANydsLeGJAABCEAAVQNcCsBdzvMmBCAAAQigaoAbAbi7YG8NSQACEIAAqga49QPkvJ6GAAQgAAE4y3kVhZEfYDI9+sJd/TvA1+/2ZfsieVUBrDu+rxzANl7MHthrKE3qfgSs+7heZMFZY8l6Pwluyd5B7O3iSOwV1NYAF+wR1Pq1PwTWD4IpewK5aeVPgvXToOC4YMpusHmF+doa4449gdydBPQs0CuhfhvqHZHeFesvo9r/NNIREh0l05FSHS2v+nj5xse/1RFsfmpWGcGuT0716Tn0DQroWzQQAUQAEaCIIOfXivXNaogAIoAIIALodEOIADrrFiKACCACiAC6FA1EAF2RCSKACCAC6BqdEAFEAF2tFyKArtsOEUAEEAGKCHLex0UE0N18oHt6QQQoIsh5c0Pd3xEiQBFBzhvd6l6/EAGKCHLe9FwEEAGKzlATgV2ztwYlAgxEUEBwxt4alAhEAHT9BJPD/9qXTAQlBFkPnJ36CV7YW4MqIJixtwblJ7hkT43KTzBlT42q5xXI+vuggIA9NC4vwRF7aFxOgiV7Z2A+gjl7ZmQdj0DWj9Xf8hBkPR3lPQdB1jfGvztMkPmV8FcHCZ7ZC8M7aQYYs/e1UDNB1suXfKqRgD2unRoIsl7NarO9BA/sZa21j2DXJeGS1t8JkPUY2c6W2z//a0WPgHVXm1fFz/qNooZWT3/9/MOqngEfzebDx4U9jQYr9pL9/QDfFlIBc4PTrAAAAABJRU5ErkJggg==" alt="">
          <%= link_to "Back to the main page", @product.from_url, class:"text-secondary" %>
          <%#  %>
        </div>
        <div class="py-3 d-none d-sm-block">
          <%# <div class="fw-bold">  %>
          <%#= @product.title %>
          <%# </div> %>
          <%# <div class="fw-bold"> $ %>
          <%#= @product.price %>
          <%# .00 </div> %>
        </div>

        <%= if  @product.product_image.present? then image_tag @product.product_image, width: "300", class:"rounded product_image" end  %>

        <div class="py-4 d-none d-sm-block"></div>

        <div>
          <div class="d-inline text-muted d-none d-sm-block">
            <p class="text d-inline">Powered by <svg class="text-muted" focusable="false" width="33" height="15">
                <g fill-rule="evenodd">
                  <path style="fill:gray"
                    d="M32.956 7.925c0-2.313-1.12-4.138-3.261-4.138-2.15 0-3.451 1.825-3.451 4.12 0 2.719 1.535 4.092 3.74 4.092 1.075 0 1.888-.244 2.502-.587V9.605c-.614.307-1.319.497-2.213.497-.876 0-1.653-.307-1.753-1.373h4.418c0-.118.018-.588.018-.804zm-4.463-.859c0-1.02.624-1.445 1.193-1.445.55 0 1.138.424 1.138 1.445h-2.33zM22.756 3.787c-.885 0-1.454.415-1.77.704l-.118-.56H18.88v10.535l2.259-.48.009-2.556c.325.235.804.57 1.6.57 1.616 0 3.089-1.302 3.089-4.166-.01-2.62-1.5-4.047-3.08-4.047zm-.542 6.225c-.533 0-.85-.19-1.066-.425l-.009-3.352c.235-.262.56-.443 1.075-.443.822 0 1.391.922 1.391 2.105 0 1.211-.56 2.115-1.39 2.115zM18.04 2.766V.932l-2.268.479v1.843zM15.772 3.94h2.268v7.905h-2.268zM13.342 4.609l-.144-.669h-1.952v7.906h2.259V6.488c.533-.696 1.436-.57 1.716-.47V3.94c-.289-.108-1.346-.307-1.879.669zM8.825 1.98l-2.205.47-.009 7.236c0 1.337 1.003 2.322 2.34 2.322.741 0 1.283-.135 1.581-.298V9.876c-.289.117-1.716.533-1.716-.804V5.865h1.716V3.94H8.816l.009-1.96zM2.718 6.235c0-.352.289-.488.767-.488.687 0 1.554.208 2.241.578V4.202a5.958 5.958 0 0 0-2.24-.415c-1.835 0-3.054.957-3.054 2.557 0 2.493 3.433 2.096 3.433 3.17 0 .416-.361.552-.867.552-.75 0-1.708-.307-2.467-.723v2.15c.84.362 1.69.515 2.467.515 1.879 0 3.17-.93 3.17-2.548-.008-2.692-3.45-2.213-3.45-3.225z">
                  </path>
                </g>
              </svg></p>
          </div>
          &nbsp;
          <div class="d-inline">
            <span class=""><a class="text-muted text-decoration-none" href="https://stripe.com/checkout/terms"
                target="_blank" rel="noopener">
                <p class="text d-inline">Terms</p>
              </a></span>
            &nbsp;
            <span class=""><a class="text-muted text-decoration-none" href="https://stripe.com/privacy" target="_blank"
                rel="noopener">
                <p class="text d-inline">Privacy</p>
              </a></span>
          </div>
        </div>



      </div> <%# col-6 %>


      <div class="col-xs-12 col-sm-6 px-4">
        <div class="form-container">
          <div class="fs-5 pb-1 text-center">Make a Payment</div>
          <p class="text text-secondary text-center">Fill out the form below</p>
          <form action="/customers" method="post" id="new_customer">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <%# this field should be empty - or IT WILL NOT SUBMIT - DONE FOR SPAMMERS - i got the idea from invisible_captcha %>
            <input type="hidden" name="tricky_field" value="">
            <input value="<%=  @product.id %>" type="hidden" name="customer[product_id]" id="customer_product_id" />
            <input value="<%=  @product.price %>" type="hidden" name="customer[price]" id="customer_price" />
            <input id="payment" type="hidden" name="customer[stripe_payment_id]" />
            <div class="pricing py-1 rounded mt-4 d-flex justify-content-between">
              <div class="d-flex flex-row align-items-center">
                <div class="d-flex flex-column ml-4">
                  <span class="product_title"> <%= @product.title %> </span>
                </div>
              </div>
              <div class="d-flex flex-row align-items-center">
                <span class="amount ml-1 mr-1"> <%=number_to_currency(@product.price) %></span>
              </div>
            </div>
                <% if @product.description!="" %>
                <div><%= @product.description %></div>
                <% end %>
            <div class="my-3"><input class="form-control" type="email" name="customer[email]" id="customer_email"
                placeholder="Email"></div>
            <div class="my-3"><input class="form-control" type="text" name="customer[name]" id="customer_name"
                placeholder="Name on Card"></div>
            <div class="">
              <div class="" id="card-number"> </div><!-- A Stripe Element will be inserted here. -->
              <div class="row  justify-content-between" style="margin:0px;">
                <div class="col-6" id="card-expiry"> </div><!-- A Stripe Element will be inserted here. -->
                <div class="col-6" id="card-cvc"> </div><!-- A Stripe Element will be inserted here. -->
              </div>
            </div>
            <div id="card-errors" role="alert"></div>
            <div class="pricing py-1 rounded mt-4 d-flex justify-content-between">
              <div class="images d-flex flex-row align-items-center">
                <div class="d-flex flex-column ml-4"> <span class="product_total"> Total: </span>
                </div>
              </div>
              <div class="d-flex flex-row align-items-center">
                <span class="totalamount ml-1 mr-1"> <%=number_to_currency(@product.price) %></span>
              </div>
            </div>
            <div class="form-group  pt-5  text-center  ">
              <input type="submit" name="commit" value="Make Payment" class="btn-lg btn-primary payment-button">
            </div>
          </form>

          <div class="pt-5 text-center">
            <%= image_tag "credit-only.png", width: "100%", style:" opacity: 0.9;max-width:300px" %>
          </div>
          <div class="pt-3 text-center"><%= image_tag "satisfaction-guarantee.png", width: "150px" %></div>

        </div>
      </div>
    </div>
  </section>
</div>

 <script src="https://js.stripe.com/v3/"></script>
 



<script>
  function validateForm() {
    var xname = document.forms["new_customer"]["customer[name]"];
    var xemail = document.forms["new_customer"]["customer[email]"];
    if (xname.value != "" && xemail.value != "") {
      return true;
    } else {

      if (xemail.value == "") {
        alert("Your email must be filled out");
        xemail.focus();
        return false;
      }

      if (xname.value == "") {
        alert("Your name must be filled out");
        xname.focus();
        return false;
      }

    }
  }
  // pk_test_zfu5fee1jfZnfOBDXg8IozT9
  var stripe = Stripe("<%=(@product.live) ? @user.pk_live : @user.pk_test %>");

  var elements = stripe.elements();




  var styles = {
    base: {
      iconColor: '#000',
      color: '#111',
      fontWeight: '600',
      fontFamily: 'Roboto Slab, Open Sans, Segoe UI, sans-serif',
      fontSize: '15px',
      fontSmoothing: 'antialiased',
      ':-webkit-autofill': {
        color: '#fce883',
      },
      '::placeholder': {
        color: '#666',
      },
    },
    invalid: {
      iconColor: '#ff0018',
      color: '#ff0018',
    },
  }

  var cardNumberElement = elements.create('cardNumber', {
    style: styles
  });
  var cardExpiryElement = elements.create('cardExpiry', {
    style: styles
  });
  var cardCvcElement = elements.create('cardCvc', {
    style: styles
  });

  cardNumberElement.mount('#card-number');
  cardExpiryElement.mount('#card-expiry');
  cardCvcElement.mount('#card-cvc');

  const form = document.querySelector('#new_customer');
  form.addEventListener('submit', function (e) {
    e.preventDefault();

    //turn off button for 5 seconds
    document.querySelector(".payment-button").disabled = true;
    setTimeout(function () {
      document.querySelector(".payment-button").disabled = false;
    }, 5000);


    // check if the name and email are entered before fetching.
    if (validateForm() == true) { //validation for name and email start
      // Step #1 Post request to create payment intent fetch
      fetch('/payment_intents', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            authenticity_token: '<%= form_authenticity_token %>',
            id: '<%=  @product.id %>',
            name: document.querySelector('#customer_name').value,
            email: document.querySelector('#customer_email').value,
          }),
        }) //fetch

        .then((response) => response.json())
        .then((paymentIntent) => {
          // Step #2 Create payment method and confirm payment intent
          stripe.confirmCardPayment(
            paymentIntent.client_secret, {
              payment_method: {
                card: cardNumberElement
                //it's enough to pass cardNumberElement - you don't have to pass exp.date nor cvc
              }
            }
          ).then((resp) => {
            if (resp.error) {
              // alert("recover things here")

              document.querySelector('#card-errors').innerHTML = resp.error.message;
              // alert(resp.error.message);
            } else {
              // Step 3: Embed payment id in form
              const paymentIdInput = document.querySelector('#payment')
              paymentIdInput.value = paymentIntent.id;
              form.submit();
            }
          })

          console.log("Success:", paymentIntent);
        })
        .catch((error) => {
          console.error('Error:', error);
        });
    } //validation end
  });
</script>

<% unless current_user.blank?
  if @product.user_id==current_user.id  %>
    <%= link_to 'Edit', edit_product_path(@product) %> |
    <%= link_to 'Back', products_path %>
  <% end %>
<% end %>
